# GitHub Actions workflow for building Android APK from WebView template
# Triggered via repository_dispatch from Web2APK API when payment is confirmed
# Validates: Requirements 6.1, 6.2, 6.3, 6.4

name: Build APK

on:
  repository_dispatch:
    types: [build_apk]

env:
  GENERATE_ID: ${{ github.event.client_payload.generate_id }}
  API_URL: ${{ github.event.client_payload.api_url }}
  KEYSTORE_PASSWORD: ${{ github.event.client_payload.keystore_password }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Validate payload
        run: |
          if [ -z "$GENERATE_ID" ]; then
            echo "Error: Missing required payload field: generate_id"
            exit 1
          fi
          echo "Building APK for generate_id: $GENERATE_ID"

      - name: Fetch build config from API
        id: config
        run: |
          CONFIG=$(curl -s "${API_URL}/api/generate/${GENERATE_ID}/build-config")
          echo "Build config received"
          
          # Parse and export as environment variables
          echo "APP_URL=$(echo $CONFIG | jq -r '.url')" >> $GITHUB_ENV
          echo "BUILD_TYPE=$(echo $CONFIG | jq -r '.build_type')" >> $GITHUB_ENV
          echo "APP_NAME=$(echo $CONFIG | jq -r '.app_name')" >> $GITHUB_ENV
          echo "PACKAGE_NAME=$(echo $CONFIG | jq -r '.package_name')" >> $GITHUB_ENV
          echo "VERSION_CODE=$(echo $CONFIG | jq -r '.version_code')" >> $GITHUB_ENV
          echo "VERSION_NAME=$(echo $CONFIG | jq -r '.version_name')" >> $GITHUB_ENV
          echo "KEYSTORE_ALIAS=$(echo $CONFIG | jq -r '.keystore_alias')" >> $GITHUB_ENV
          echo "KEYSTORE_KEY=$(echo $CONFIG | jq -r '.keystore_key // empty')" >> $GITHUB_ENV
          echo "ENABLE_GPS=$(echo $CONFIG | jq -r '.enable_gps')" >> $GITHUB_ENV
          echo "ENABLE_CAMERA=$(echo $CONFIG | jq -r '.enable_camera')" >> $GITHUB_ENV
          
          echo "Build Type: $BUILD_TYPE"
          echo "App Name: $APP_NAME"
          echo "Package Name: $PACKAGE_NAME"
          echo "Version: $VERSION_NAME ($VERSION_CODE)"
          echo "Enable GPS: $ENABLE_GPS"
          echo "Enable Camera: $ENABLE_CAMERA"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Download icon from API
        run: |
          mkdir -p webviewCatatUang/app/src/main/res/mipmap-xxxhdpi
          curl -L -o icon_512.png "${API_URL}/api/icon/${GENERATE_ID}" || {
            echo "Failed to download icon"
            exit 1
          }
          echo "Icon downloaded successfully"

      - name: Install ImageMagick for icon processing
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Remove existing icon XML files and generate PNG icons
        run: |
          # Remove existing XML icon files to avoid duplicate resource errors
          find webviewCatatUang/app/src/main/res -name "ic_launcher*.xml" -delete
          find webviewCatatUang/app/src/main/res -name "ic_launcher*.webp" -delete
          rm -rf webviewCatatUang/app/src/main/res/mipmap-anydpi-v26

          # Generate different density icons from 512x512 source
          convert icon_512.png -resize 48x48 webviewCatatUang/app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert icon_512.png -resize 72x72 webviewCatatUang/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert icon_512.png -resize 96x96 webviewCatatUang/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert icon_512.png -resize 144x144 webviewCatatUang/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert icon_512.png -resize 192x192 webviewCatatUang/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png

          # Also create round icons
          cp webviewCatatUang/app/src/main/res/mipmap-mdpi/ic_launcher.png webviewCatatUang/app/src/main/res/mipmap-mdpi/ic_launcher_round.png
          cp webviewCatatUang/app/src/main/res/mipmap-hdpi/ic_launcher.png webviewCatatUang/app/src/main/res/mipmap-hdpi/ic_launcher_round.png
          cp webviewCatatUang/app/src/main/res/mipmap-xhdpi/ic_launcher.png webviewCatatUang/app/src/main/res/mipmap-xhdpi/ic_launcher_round.png
          cp webviewCatatUang/app/src/main/res/mipmap-xxhdpi/ic_launcher.png webviewCatatUang/app/src/main/res/mipmap-xxhdpi/ic_launcher_round.png
          cp webviewCatatUang/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png webviewCatatUang/app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png
          echo "Icon sizes generated successfully"

      - name: Download HTML files from R2
        if: env.BUILD_TYPE == 'html'
        run: |
          curl -L -o html_files.zip "${API_URL}/api/html-files/${GENERATE_ID}" || {
            echo "Failed to download HTML files"
            exit 1
          }
          mkdir -p webviewCatatUang/app/src/main/assets
          unzip -q html_files.zip -d webviewCatatUang/app/src/main/assets/
          if [ ! -f "webviewCatatUang/app/src/main/assets/index.html" ]; then
            echo "Error: index.html not found"
            exit 1
          fi
          echo "HTML files extracted successfully"

      - name: Extract package name parts
        id: package
        run: |
          PACKAGE_PATH=$(echo "$PACKAGE_NAME" | tr '.' '/')
          echo "package_path=$PACKAGE_PATH" >> $GITHUB_OUTPUT

      - name: Customize and copy MainActivity.kt from template
        run: |
          # The full-featured MainActivity.kt template lives in the repo at:
          # webviewCatatUang/app/src/main/java/com/catatung/app/MainActivity.kt
          # We copy it to the target package path and inject runtime values via sed.

          GPS_ENABLED="${ENABLE_GPS:-false}"
          CAMERA_ENABLED="${ENABLE_CAMERA:-false}"

          # Determine URL based on build type
          if [ "$BUILD_TYPE" = "html" ]; then
            APP_URL_PLACEHOLDER="file:///android_asset/index.html"
          else
            APP_URL_PLACEHOLDER="$APP_URL"
          fi

          TARGET_DIR="webviewCatatUang/app/src/main/java/${{ steps.package.outputs.package_path }}"
          mkdir -p "$TARGET_DIR"
          MAIN_KT="$TARGET_DIR/MainActivity.kt"

          # Copy template from repo
          cp webviewCatatUang/app/src/main/java/com/catatung/app/MainActivity.kt "$MAIN_KT"

          # ── Basic substitutions ──
          sed -i "s|__PACKAGE_NAME__|$PACKAGE_NAME|g" "$MAIN_KT"
          sed -i "s|__APP_URL__|$APP_URL_PLACEHOLDER|g" "$MAIN_KT"

          # ── GPS: import ──
          if [ "$GPS_ENABLED" = "true" ]; then
            sed -i 's|// __GPS_IMPORT__|import android.webkit.GeolocationPermissions|g' "$MAIN_KT"
          else
            sed -i '/\/\/ __GPS_IMPORT__/d' "$MAIN_KT"
          fi

          # ── GPS: permission constant ──
          if [ "$GPS_ENABLED" = "true" ]; then
            sed -i 's|// __GPS_PERMISSION_CONST__|private val LOCATION_PERMISSION_REQUEST_CODE = 1000|g' "$MAIN_KT"
          else
            sed -i '/\/\/ __GPS_PERMISSION_CONST__/d' "$MAIN_KT"
          fi

          # ── GPS: request permission in onCreate ──
          if [ "$GPS_ENABLED" = "true" ]; then
            sed -i 's|// __GPS_PERMISSION_REQUEST__|if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) { ActivityCompat.requestPermissions(this, arrayOf(Manifest.permission.ACCESS_FINE_LOCATION), LOCATION_PERMISSION_REQUEST_CODE) }|g' "$MAIN_KT"
          else
            sed -i '/\/\/ __GPS_PERMISSION_REQUEST__/d' "$MAIN_KT"
          fi

          # ── GPS: geolocation WebChromeClient method ──
          if [ "$GPS_ENABLED" = "true" ]; then
            sed -i 's|// __GEOLOCATION_METHOD__|override fun onGeolocationPermissionsShowPrompt(origin: String?, callback: GeolocationPermissions.Callback?) { callback?.invoke(origin, true, false) }|g' "$MAIN_KT"
          else
            sed -i '/\/\/ __GEOLOCATION_METHOD__/d' "$MAIN_KT"
          fi

          # ── GPS: onRequestPermissionsResult case ──
          if [ "$GPS_ENABLED" = "true" ]; then
            sed -i 's|// __GPS_PERMISSION_RESULT__|LOCATION_PERMISSION_REQUEST_CODE -> { if (grantResults.isNotEmpty() \&\& grantResults[0] == PackageManager.PERMISSION_GRANTED) { } }|g' "$MAIN_KT"
          else
            sed -i '/\/\/ __GPS_PERMISSION_RESULT__/d' "$MAIN_KT"
          fi

          # ── Camera: import ──
          if [ "$CAMERA_ENABLED" = "true" ]; then
            sed -i 's|// __CAMERA_IMPORT__|import android.webkit.PermissionRequest|g' "$MAIN_KT"
          else
            sed -i '/\/\/ __CAMERA_IMPORT__/d' "$MAIN_KT"
          fi

          # ── Camera: WebRTC permission method ──
          if [ "$CAMERA_ENABLED" = "true" ]; then
            sed -i 's|// __CAMERA_PERMISSION_METHOD__|override fun onPermissionRequest(request: PermissionRequest?) { runOnUiThread { request?.grant(request.resources) } }|g' "$MAIN_KT"
          else
            sed -i '/\/\/ __CAMERA_PERMISSION_METHOD__/d' "$MAIN_KT"
          fi

          # Remove the original com/catatung source dir (will be replaced by target)
          if [ "${{ steps.package.outputs.package_path }}" != "com/catatung/app" ]; then
            rm -rf webviewCatatUang/app/src/main/java/com/catatung
          fi

          echo "MainActivity.kt customized successfully"
          echo "  Package: $PACKAGE_NAME"
          echo "  URL: $APP_URL_PLACEHOLDER"
          echo "  GPS: $GPS_ENABLED | Camera: $CAMERA_ENABLED"

      - name: Replace strings.xml
        run: |
          cat > webviewCatatUang/app/src/main/res/values/strings.xml << EOF
          <resources>
              <string name="app_name">${APP_NAME}</string>
          </resources>
          EOF

      - name: Replace build.gradle
        env:
          KEYSTORE_PASSWORD_SHARED: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS_SHARED: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD_SHARED: ${{ secrets.KEY_PASSWORD }}
        run: |
          cat > webviewCatatUang/app/build.gradle << 'GRADLE_EOF'
          plugins {
              id 'com.android.application'
              id 'org.jetbrains.kotlin.android'
          }
          android {
              namespace '__PACKAGE_NAME__'
              compileSdk 35
              defaultConfig {
                  applicationId "__PACKAGE_NAME__"
                  minSdk 24
                  targetSdk 35
                  versionCode __VERSION_CODE__
                  versionName "__VERSION_NAME__"
                  testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
              }
              signingConfigs {
                  release {
                      storeFile file('release-keystore.jks')
                      storePassword System.getenv("APP_KEYSTORE_PASSWORD")
                      keyAlias System.getenv("APP_KEY_ALIAS")
                      keyPassword System.getenv("APP_KEY_PASSWORD")
                  }
              }
              buildTypes {
                  release {
                      minifyEnabled true
                      shrinkResources true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                      signingConfig signingConfigs.release
                  }
              }
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = '17' }
              buildFeatures { viewBinding true }
          }
          dependencies {
              implementation 'androidx.core:core-ktx:1.12.0'
              implementation 'androidx.appcompat:appcompat:1.6.1'
              implementation 'com.google.android.material:material:1.11.0'
              implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
              implementation 'androidx.swiperefreshlayout:swiperefreshlayout:1.1.0'
              implementation 'androidx.browser:browser:1.8.0'
          }
          GRADLE_EOF
          sed -i "s/__PACKAGE_NAME__/$PACKAGE_NAME/g" webviewCatatUang/app/build.gradle
          sed -i "s/__VERSION_CODE__/${VERSION_CODE:-1}/g" webviewCatatUang/app/build.gradle
          sed -i "s/__VERSION_NAME__/${VERSION_NAME:-1.0}/g" webviewCatatUang/app/build.gradle

          # Export variables for the build step (all builds use per-project credentials)
          if [ -z "$KEYSTORE_ALIAS" ]; then
            echo "Error: KEYSTORE_ALIAS is required" >&2
            exit 1
          fi
          echo "APP_KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "APP_KEY_ALIAS=$KEYSTORE_ALIAS" >> $GITHUB_ENV
          echo "APP_KEY_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV

      - name: Replace AndroidManifest.xml
        run: |
          # Determine which permissions to add
          GPS_ENABLED="${ENABLE_GPS:-false}"
          CAMERA_ENABLED="${ENABLE_CAMERA:-false}"

          # Build permission lines
          GPS_PERMISSIONS=""
          if [ "$GPS_ENABLED" = "true" ]; then
            GPS_PERMISSIONS="    <uses-permission android:name=\"android.permission.ACCESS_FINE_LOCATION\" />
              <uses-permission android:name=\"android.permission.ACCESS_COARSE_LOCATION\" />"
          fi

          CAMERA_PERMISSIONS=""
          if [ "$CAMERA_ENABLED" = "true" ]; then
            CAMERA_PERMISSIONS="    <uses-permission android:name=\"android.permission.CAMERA\" />
              <uses-permission android:name=\"android.permission.READ_EXTERNAL_STORAGE\" android:maxSdkVersion=\"32\" />
              <uses-permission android:name=\"android.permission.READ_MEDIA_IMAGES\" />
              <uses-feature android:name=\"android.hardware.camera\" android:required=\"false\" />"
          fi

          cat > webviewCatatUang/app/src/main/AndroidManifest.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              xmlns:tools="http://schemas.android.com/tools">
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
              <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
              <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="28" />
              <uses-permission android:name="android.permission.DOWNLOAD_WITHOUT_NOTIFICATION" />
          ${GPS_PERMISSIONS}
          ${CAMERA_PERMISSIONS}
              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:label="@string/app_name"
                  android:roundIcon="@mipmap/ic_launcher_round"
                  android:supportsRtl="true"
                  android:theme="@style/Theme.WebViewApp"
                  android:usesCleartextTraffic="true"
                  tools:targetApi="35">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:theme="@style/Theme.WebViewApp.NoActionBar"
                      android:screenOrientation="portrait">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          echo "AndroidManifest.xml replaced with GPS=$GPS_ENABLED, Camera=$CAMERA_ENABLED"

      - name: Replace settings.gradle
        run: |
          SANITIZED_NAME=$(echo "$APP_NAME" | tr -cd '[:alnum:]')
          cat > webviewCatatUang/settings.gradle << EOF
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "${SANITIZED_NAME}"
          include ':app'
          EOF

      - name: Update themes.xml
        run: |
          cat > webviewCatatUang/app/src/main/res/values/themes.xml << 'EOF'
          <resources xmlns:tools="http://schemas.android.com/tools">
              <style name="Theme.WebViewApp" parent="Theme.MaterialComponents.DayNight.DarkActionBar">
                  <item name="colorPrimary">@color/purple_500</item>
                  <item name="colorPrimaryVariant">@color/purple_700</item>
                  <item name="colorOnPrimary">@color/white</item>
                  <item name="colorSecondary">@color/teal_200</item>
                  <item name="colorSecondaryVariant">@color/teal_700</item>
                  <item name="colorOnSecondary">@color/black</item>
                  <item name="android:statusBarColor">?attr/colorPrimaryVariant</item>
              </style>
              <style name="Theme.WebViewApp.NoActionBar">
                  <item name="windowActionBar">false</item>
                  <item name="windowNoTitle">true</item>
              </style>
          </resources>
          EOF

      - name: Update colors.xml
        run: |
          cat > webviewCatatUang/app/src/main/res/values/colors.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <resources>
              <color name="purple_200">#FFBB86FC</color>
              <color name="purple_500">#FF6200EE</color>
              <color name="purple_700">#FF3700B3</color>
              <color name="teal_200">#FF03DAC5</color>
              <color name="teal_700">#FF018786</color>
              <color name="black">#FF000000</color>
              <color name="white">#FFFFFFFF</color>
          </resources>
          EOF

      - name: Generate per-project keystore (all builds)
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          # Check if keystore already exists (rebuild) or generate new one (first build)
          if [ -n "$KEYSTORE_KEY" ]; then
            # Download existing keystore from R2 (for rebuild with same signature)
            pip install awscli
            aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
            aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
            aws configure set default.region auto
            aws s3 cp "s3://${R2_BUCKET}/${KEYSTORE_KEY}" webviewCatatUang/app/release-keystore.jks --endpoint-url "$R2_ENDPOINT"
            echo "Downloaded existing keystore for rebuild (key: $KEYSTORE_KEY)"
          else
            # Generate new keystore for first build
            KEYSTORE_ALIAS_VALUE="${KEYSTORE_ALIAS:-release}"

            keytool -genkeypair \
              -alias "$KEYSTORE_ALIAS_VALUE" \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -keystore webviewCatatUang/app/release-keystore.jks \
              -storepass "$KEYSTORE_PASSWORD" \
              -keypass "$KEYSTORE_PASSWORD" \
              -dname "CN=$APP_NAME, OU=Development, O=Web2APK, C=ID"
            echo "Generated new keystore (alias: $KEYSTORE_ALIAS_VALUE)"
          fi

      - name: Grant execute permission for gradlew
        run: chmod +x webviewCatatUang/gradlew

      - name: Build Release APK
        working-directory: webviewCatatUang
        run: ./gradlew assembleRelease --no-daemon

      - name: Find APK file
        id: find_apk
        run: |
          APK_PATH=$(find webviewCatatUang/app/build/outputs/apk/release -name "*.apk" | head -1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT

      - name: Build Release AAB
        working-directory: webviewCatatUang
        run: ./gradlew bundleRelease --no-daemon

      - name: Find AAB file
        id: find_aab
        run: |
          AAB_PATH=$(find webviewCatatUang/app/build/outputs/bundle/release -name "*.aab" | head -1)
          echo "aab_path=$AAB_PATH" >> $GITHUB_OUTPUT

      - name: Upload APK to R2
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          pip install awscli
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set default.region auto
          APK_KEY="apks/${GENERATE_ID}.apk"
          aws s3 cp "${{ steps.find_apk.outputs.apk_path }}" "s3://${R2_BUCKET}/${APK_KEY}" --endpoint-url "$R2_ENDPOINT"
          echo "apk_key=$APK_KEY" >> $GITHUB_ENV

      - name: Upload AAB to R2
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          pip install awscli
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set default.region auto
          AAB_KEY="aabs/${GENERATE_ID}.aab"
          aws s3 cp "${{ steps.find_aab.outputs.aab_path }}" "s3://${R2_BUCKET}/${AAB_KEY}" --endpoint-url "$R2_ENDPOINT"
          echo "aab_key=$AAB_KEY" >> $GITHUB_ENV

      - name: Upload keystore to R2 (first build only)
        if: env.KEYSTORE_KEY == ''
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          pip install awscli
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set default.region auto
          KEYSTORE_KEY="keystores/${GENERATE_ID}/keystore.jks"
          aws s3 cp webviewCatatUang/app/release-keystore.jks "s3://${R2_BUCKET}/${KEYSTORE_KEY}" --endpoint-url "$R2_ENDPOINT"
          echo "keystore_key=$KEYSTORE_KEY" >> $GITHUB_ENV

      - name: Call success callback
        if: success()
        env:
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          PAYLOAD="{\"generate_id\": \"$GENERATE_ID\", \"status\": \"success\", \"apk_key\": \"$apk_key\""
          if [ -n "$aab_key" ]; then
            PAYLOAD="$PAYLOAD, \"aab_key\": \"$aab_key\""
          fi
          # Use uploaded keystore_key (first build) or existing KEYSTORE_KEY (rebuild)
          ACTUAL_KEYSTORE_KEY="$keystore_key"
          if [ -z "$ACTUAL_KEYSTORE_KEY" ] && [ -n "$KEYSTORE_KEY" ]; then
            ACTUAL_KEYSTORE_KEY="$KEYSTORE_KEY"
          fi
          if [ -n "$ACTUAL_KEYSTORE_KEY" ]; then
            PAYLOAD="$PAYLOAD, \"keystore_key\": \"$ACTUAL_KEYSTORE_KEY\""
          fi
          PAYLOAD="$PAYLOAD}"
          curl -X POST "${API_URL}/api/webhook/build-complete" -H "Content-Type: application/json" -H "X-Webhook-Secret: $WEBHOOK_SECRET" \
            -d "$PAYLOAD"

      - name: Call failure callback
        if: failure()
        env:
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          curl -X POST "${API_URL}/api/webhook/build-complete" -H "Content-Type: application/json" -H "X-Webhook-Secret: $WEBHOOK_SECRET" \
            -d "{\"generate_id\": \"$GENERATE_ID\", \"status\": \"failed\", \"error_message\": \"Build failed\"}"
